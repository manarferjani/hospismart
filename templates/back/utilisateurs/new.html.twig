{% extends 'back.html.twig' %}

{% block title %}Nouvel utilisateur - Hospismart{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .form-container {
        max-width: 1000px;
        margin: 0 auto;
    }

    .form-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 30px;
        margin-bottom: 25px;
        border-top: 4px solid #3b82f6;
    }

    .form-card h3 {
        font-size: 1.2rem;
        color: #1e293b;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .form-group { margin-bottom: 15px; }

    .form-label {
        font-weight: 600;
        color: #475569;
        margin-bottom: 8px;
        display: block;
        font-size: 14px;
    }

    .form-control, .form-select {
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        padding: 10px 15px;
        width: 100%;
        transition: 0.3s;
    }

    .form-control:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .btn-save {
        background: #27ae60;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-save:hover { background: #219150; transform: translateY(-2px); }

    .btn-cancel {
        background: #f1f5f9;
        color: #64748b;
        padding: 12px 30px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
    }

    .field-error { color: #dc2626; font-size: 12px; margin-top: 5px; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="m-0 fw-bold" style="font-size: 24px;">➕ Ajouter un utilisateur</h1>
        <small class="text-muted">Créez un profil pour un patient, un médecin ou un administrateur.</small>
    </div>
    <a href="{{ path('app_dashboard_utilisateurs_list') }}" class="btn-cancel">
        <i class="fa-solid fa-arrow-left me-2"></i>Retour
    </a>
</div>

{% if errors %}
    <div class="alert alert-danger border-0 shadow-sm mb-4" style="border-radius: 12px;">
        <i class="fa-solid fa-circle-exclamation me-2"></i><strong>Erreurs de validation :</strong>
        <ul class="mb-0 mt-2">
            {% for err in errors %}<li>{{ err }}</li>{% endfor %}
        </ul>
    </div>
{% endif %}

<div class="form-container">
    <form method="post" action="{{ path('app_dashboard_utilisateurs_new') }}" class="js-form-validate" data-password-minlength="6">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token('new_user') }}">

        <div class="form-card">
            <h3><i class="fa-solid fa-user-gear text-primary"></i> Informations du compte</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="nom">Nom *</label>
                    <input type="text" id="nom" name="nom" class="form-control" value="{{ formData.nom ?? '' }}" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="prenom">Prénom *</label>
                    <input type="text" id="prenom" name="prenom" class="form-control" value="{{ formData.prenom ?? '' }}" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="email">Email *</label>
                    <input type="email" id="email" name="email" class="form-control" value="{{ formData.email ?? '' }}" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="telephone">Téléphone</label>
                    <input type="text" id="telephone" name="telephone" class="form-control" value="{{ formData.telephone ?? '' }}">
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">Mot de passe *</label>
                    <input type="password" id="password" name="password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="role">Rôle assigné *</label>
                    <select id="role" name="role" class="form-select" required>
                        <option value="ROLE_PATIENT" {{ (formData.role ?? 'ROLE_PATIENT') == 'ROLE_PATIENT' ? 'selected' : '' }}>Patient</option>
                        <option value="ROLE_MEDECIN" {{ (formData.role ?? '') == 'ROLE_MEDECIN' ? 'selected' : '' }}>Médecin</option>
                        <option value="ROLE_ADMIN" {{ (formData.role ?? '') == 'ROLE_ADMIN' ? 'selected' : '' }}>Administrateur</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="patient-fields" class="form-card">
            <h3><i class="fa-solid fa-hospital-user text-success"></i> Profil Patient</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="genre">Genre *</label>
                    <select id="genre" name="genre" class="form-select">
                        <option value="">-- Sélectionner --</option>
                        <option value="Homme" {{ (formData.genre ?? '') == 'Homme' ? 'selected' : '' }}>Homme</option>
                        <option value="Femme" {{ (formData.genre ?? '') == 'Femme' ? 'selected' : '' }}>Femme</option>
                        <option value="Autre" {{ (formData.genre ?? '') == 'Autre' ? 'selected' : '' }}>Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="date_naissance">Date de naissance *</label>
                    <input type="date" id="date_naissance" name="date_naissance" class="form-control" value="{{ formData.dateNaissance ?? '' }}">
                </div>
                <div class="form-group">
                    <label class="form-label" for="groupe_sanguin">Groupe sanguin</label>
                    <input type="text" id="groupe_sanguin" name="groupe_sanguin" class="form-control" value="{{ formData.groupeSanguin ?? '' }}" placeholder="ex: AB+">
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label" for="adresse">Adresse complète</label>
                    <input type="text" id="adresse" name="adresse" class="form-control" value="{{ formData.adresse ?? '' }}">
                </div>
            </div>
        </div>

        <div id="medecin-fields" class="form-card" style="display:none; border-top-color: #10b981;">
            <h3><i class="fa-solid fa-user-md text-success"></i> Profil Médecin</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="specialite">Spécialité *</label>
                    <input type="text" id="specialite" name="specialite" class="form-control" value="{{ formData.specialite ?? 'Généraliste' }}">
                </div>
                <div class="form-group">
                    <label class="form-label" for="matricule">Numéro de matricule *</label>
                    <input type="text" id="matricule" name="matricule" class="form-control" value="{{ formData.matricule ?? '' }}" placeholder="Ex: MED-2024-001">
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-3 mt-4 mb-5">
            <a href="{{ path('app_dashboard_utilisateurs_list') }}" class="btn-cancel">Annuler</a>
            <button type="submit" class="btn-save shadow-sm">
                <i class="fa-solid fa-user-plus me-2"></i>Créer l'utilisateur
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('role');
    const patientFields = document.getElementById('patient-fields');
    const medecinFields = document.getElementById('medecin-fields');
    
    const genreSelect = document.getElementById('genre');
    const dateInput = document.getElementById('date_naissance');
    const specialiteInput = document.getElementById('specialite');
    const matriculeInput = document.getElementById('matricule');
    
    function updateFields() {
        const selectedRole = roleSelect.value;
        
        // Reset display
        patientFields.style.display = 'none';
        medecinFields.style.display = 'none';
        
        // Remove all required
        [genreSelect, dateInput, specialiteInput, matriculeInput].forEach(el => el.removeAttribute('required'));

        if (selectedRole === 'ROLE_PATIENT') {
            patientFields.style.display = 'block';
            genreSelect.setAttribute('required', 'required');
            dateInput.setAttribute('required', 'required');
        } else if (selectedRole === 'ROLE_MEDECIN') {
            medecinFields.style.display = 'block';
            specialiteInput.setAttribute('required', 'required');
            matriculeInput.setAttribute('required', 'required');
        }
    }
    
    roleSelect.addEventListener('change', updateFields);
    updateFields(); // Init
});
</script>
{% endblock %}