{% extends 'back.html.twig' %}

{% block title %}Liste des Réclamations - Hospismart{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    /* Structure de la page */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 25px;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* FIX DES BOUTONS DE TRI (En haut à droite) */
    .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .sort-group {
        display: flex;
        gap: 8px;
    }

    .btn-sort {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        color: #475569;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
        text-decoration: none;
        white-space: nowrap;
    }

    .btn-sort:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        transform: translateY(-1px);
    }

    .btn-sort i {
        font-size: 14px;
    }

    /* Barre de filtres */
    .filters-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* Tableau */
    .complaints-table-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 20px;
    }

    .custom-table { width: 100%; border-collapse: collapse; }
    .custom-table th { background: #f8fafc; padding: 15px; text-align: left; color: #64748b; font-weight: 600; font-size: 13px; border-bottom: 2px solid #edf2f7; }
    .custom-table td { padding: 15px; border-top: 1px solid #f1f5f9; vertical-align: middle; font-size: 14px; }

    /* Statuts */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .bg-traite { background: #dcfce7; color: #166534; }
    .bg-cours { background: #dbeafe; color: #1e40af; }
    .bg-attente { background: #fef3c7; color: #92400e; }

    /* Priorité */
    .priority-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .priority-basse { background: #dcfce7; color: #166534; }
    .priority-normale { background: #e0e7ff; color: #4338ca; }
    .priority-haute { background: #fef3c7; color: #92400e; }
    .priority-urgente { background: #fee2e2; color: #991b1b; }

    /* Actions en fin de ligne */
    .btn-action-group { display: flex; gap: 8px; justify-content: flex-end; }
    .btn-circle {
        width: 34px; height: 34px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 8px; transition: 0.3s;
        text-decoration: none;
        border: none;
        cursor: pointer;
    }
    .btn-view { background: #eff6ff; color: #2563eb; }
    .btn-view:hover { background: #dbeafe; color: #1d4ed8; }
    .btn-reply { background: #f0fdf4; color: #16a34a; }
    .btn-reply:hover { background: #dcfce7; color: #15803d; }
    .btn-delete { background: #fef2f2; color: #dc2626; }
    .btn-delete:hover { background: #fee2e2; color: #b91c1c; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-title">
        <h1 class="m-0 fw-bold" style="font-size: 24px;">
            <i class="fa-solid fa-headset text-primary me-2"></i>Réclamations
        </h1>
    </div>
    
    <div class="header-actions">
        <span class="text-muted fw-semibold">Trier par :</span>
        <div class="sort-group">
            <a href="{{ path('back_office_dashboard', {'sortBy': 'date', 'sortOrder': sortOrder == 'DESC' ? 'ASC' : 'DESC'}) }}" class="btn-sort shadow-sm">
                <i class="fa-solid fa-calendar-days text-warning"></i> Date
            </a>
            <a href="{{ path('back_office_dashboard', {'sortBy': 'nomPatient', 'sortOrder': sortOrder == 'DESC' ? 'ASC' : 'DESC'}) }}" class="btn-sort shadow-sm">
                <i class="fa-solid fa-user text-primary"></i> Patient
            </a>
        </div>
    </div>
</div>

<div class="filters-card">
    <form method="GET" action="{{ path('back_office_dashboard') }}" class="row g-3">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0 text-muted"><i class="fa-solid fa-magnifying-glass"></i></span>
                <input type="text" name="searchQuery" class="form-control border-start-0" placeholder="Rechercher..." value="{{ searchQuery ?? '' }}">
            </div>
        </div>
        <div class="col-md-2">
            <select name="filterCategorie" class="form-select border-light bg-light">
                <option value="">Catégorie</option>
                <option value="Service médical" {% if filterCategorie == 'Service médical' %}selected{% endif %}>Service médical</option>
                <option value="Accueil" {% if filterCategorie == 'Accueil' %}selected{% endif %}>Accueil</option>
                <option value="Facturation" {% if filterCategorie == 'Facturation' %}selected{% endif %}>Facturation</option>
                <option value="Hygiène" {% if filterCategorie == 'Hygiène' %}selected{% endif %}>Hygiène</option>
                <option value="Autre" {% if filterCategorie == 'Autre' %}selected{% endif %}>Autre</option>
            </select>
        </div>
        <div class="col-md-2">
            <select name="filterPriorite" class="form-select border-light bg-light">
                <option value="">Priorité</option>
                <option value="Basse" {% if filterPriorite == 'Basse' %}selected{% endif %}>Basse</option>
                <option value="Normale" {% if filterPriorite == 'Normale' %}selected{% endif %}>Normale</option>
                <option value="Haute" {% if filterPriorite == 'Haute' %}selected{% endif %}>Haute</option>
                <option value="Urgente" {% if filterPriorite == 'Urgente' %}selected{% endif %}>Urgente</option>
            </select>
        </div>
        <div class="col-md-2">
            <select name="filterStatutSearch" class="form-select border-light bg-light">
                <option value="total" {% if filterStatutSearch == 'total' %}selected{% endif %}>Statut</option>
                <option value="En attente" {% if filterStatutSearch == 'En attente' %}selected{% endif %}>En attente</option>
                <option value="En cours" {% if filterStatutSearch == 'En cours' %}selected{% endif %}>En cours</option>
                <option value="Traité" {% if filterStatutSearch == 'Traité' %}selected{% endif %}>Traité</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100 shadow-sm">Chercher</button>
        </div>
    </form>
</div>

<div class="complaints-table-card">
    <div class="table-responsive">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Titre / Date</th>
                    <th>Patient</th>
                    <th>Priorité</th>
                    <th>Statut</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for reclamation in reclamations %}
                <tr>
                    <td><span class="text-muted fw-bold">#{{ reclamation.id }}</span></td>
                    <td>
                        <div class="fw-bold text-dark">{{ reclamation.titre|slice(0, 35) }}{% if reclamation.titre|length > 35 %}...{% endif %}</div>
                        <small class="text-muted"><i class="fa-regular fa-clock me-1"></i>{{ reclamation.dateCreation|date('d/m/Y') }}</small>
                    </td>
                    <td>
                        <div class="fw-bold">{{ reclamation.nomPatient }}</div>
                        <div class="small text-muted">{{ reclamation.email }}</div>
                    </td>
                    <td>
                        <span class="priority-badge priority-{{ reclamation.priorite|lower }}">{{ reclamation.priorite }}</span>
                    </td>
                    <td>
                        {% if reclamation.statut == 'Traité' %}
                            <span class="status-badge bg-traite">Traité</span>
                        {% elseif reclamation.statut == 'En cours' %}
                            <span class="status-badge bg-cours">En cours</span>
                        {% else %}
                            <span class="status-badge bg-attente">En attente</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-action-group">
                            <a href="{{ path('back_office_voir_reclamation', {'id': reclamation.id}) }}" class="btn-circle btn-view" title="Voir">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                            <a href="{{ path('back_office_repondre_reclamation', {'id': reclamation.id}) }}" class="btn-circle btn-reply" title="Répondre">
                                <i class="fa-solid fa-reply"></i>
                            </a>
                            <form method="post" action="{{ path('back_office_supprimer_reclamation', {'id': reclamation.id}) }}" style="display:inline;" onsubmit="return confirm('Supprimer cette réclamation ?');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reclamation.id) }}">
                                <button type="submit" class="btn-circle btn-delete" title="Supprimer">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">Aucune réclamation.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}